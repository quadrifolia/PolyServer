# PolyServer Base System Configuration
# This file contains default values for hardened Debian server foundation.
# Override with environment variables or deployment-specific configuration files.

# =============================================================================
# BASE SYSTEM CONFIGURATION
# =============================================================================

# System configuration
DEPLOY_USER=deploy
USERNAME=deploy
DEPLOY_DIR=/opt/polyserver
HOSTNAME=polyserver
SSH_PORT=2222

# SSH Security Configuration
# If SSH_PUBLIC_KEY is provided, password authentication will be disabled
# If left empty, password authentication will be enabled for initial setup
# Example: SSH_PUBLIC_KEY="ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIG... your-email@example.com"
SSH_PUBLIC_KEY=""

# Deployment mode: affects how certain services are configured
# - docker: Optimizations for containerized applications, nginx as reverse proxy
# - baremetal: Traditional deployment, applications run directly on server
# Note: Set to "docker" if INSTALL_DOCKER=true, "baremetal" otherwise
DEPLOYMENT_MODE=baremetal

# System defaults
USER_ID=1000
GROUP_ID=1000
TIMEZONE=Europe/Berlin
SERVER_TIMEZONE=Europe/Berlin

# =============================================================================
# BACKUP CONFIGURATION
# =============================================================================

# Backup settings
BACKUP_RETENTION_DAYS=30
BACKUP_SCHEDULE="0 2 * * *"  # Daily at 2 AM

# Block storage mount point (for dedicated backup volumes)
# Only relevant if you have attached block storage (e.g., OVH additional disk)
# Leave as default if using S3-only backups
BACKUP_MOUNT=/mnt/backup

# S3-Compatible Object Storage settings (recommended for application backups)
# Works with any S3-compatible provider: AWS S3, OVH Object Storage, Cloudflare R2, MinIO, etc.
S3_BUCKET=polyserver-backups
S3_PREFIX=production

# S3 Provider Configuration
# Examples:
#   AWS S3:           S3_REGION=us-east-1, S3_ENDPOINT=https://s3.us-east-1.amazonaws.com
#   OVH:              S3_REGION=gra, S3_ENDPOINT=https://s3.gra.cloud.ovh.net
#   Cloudflare R2:    S3_REGION=auto, S3_ENDPOINT=https://<account-id>.r2.cloudflarestorage.com
#   MinIO:            S3_REGION=us-east-1, S3_ENDPOINT=https://minio.example.com
S3_REGION=us-east-1
# S3_ENDPOINT=  # Optional: Auto-detected for AWS, required for other providers

# S3 Access Credentials (required for all providers)
# These generic variable names work with any S3-compatible provider:
#   AWS S3: Use IAM user access keys with s3:ListBucket, s3:PutObject, s3:DeleteObject
#   OVH: Use S3 user credentials from Public Cloud with read/write access
#   Cloudflare R2: Use API token with Object Read & Write permissions
#   MinIO: Use access key and secret key from MinIO console with readwrite policy
#
# Required permissions for backup script:
#   - List bucket contents (check if bucket exists, count backups)
#   - Upload objects (write backups)
#   - Delete objects (cleanup old backups)
#   - Create bucket (optional, only if bucket doesn't exist yet)
#
# Note: The backup script will export these as AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY
# since the AWS CLI tool requires those specific names even for non-AWS S3 services
# S3_ACCESS_KEY_ID=your_access_key
# S3_SECRET_ACCESS_KEY=your_secret_key

# Backup encryption (strongly recommended)
# Generate with: openssl rand -base64 32
# BACKUP_ENCRYPTION_KEY=your_strong_encryption_key

# =============================================================================
# COMPONENT INSTALLATION CONFIGURATION
# =============================================================================

# Web Server & Application Stack Components
# Configure which components to install during server setup
# Security hardening is ALWAYS installed regardless of these settings

# Web server (required for web applications)
# Nginx web server (recommended for reverse proxy and static file serving)
INSTALL_NGINX=true

# Nginx-specific settings (only used if INSTALL_NGINX=true)
# Base domain for default nginx configuration and SSL certificates
BASE_DOMAIN=example.com

# Application runtimes (install only what you need)
# PHP 8.4 with php-fpm (disable for Docker-only setups)
INSTALL_PHP=false
# Node.js LTS with npm (disable for Docker-only setups)
INSTALL_NODEJS=false

# Databases (install only what you need)
# MariaDB/MySQL database server
INSTALL_MARIADB=false
# PostgreSQL database server
INSTALL_POSTGRESQL=false
# Redis in-memory data store
INSTALL_REDIS=false

# Container platform
# Docker CE with docker-compose (recommended for modern deployments)
INSTALL_DOCKER=true

# Docker-specific settings (only used if INSTALL_DOCKER=true)
# Docker network name for container communication
DOCKER_NETWORK=polyserver-network
# Docker compose files directory
DOCKER_COMPOSE_DIR=/opt/polyserver/docker/compose
# Docker volumes directory
DOCKER_VOLUMES_DIR=/opt/polyserver/docker/volumes
# Backend application settings for Docker mode reverse proxy
BACKEND_HOST=127.0.0.1
BACKEND_PORT=3000

# Development tools (optional)
# Git version control (recommended)
INSTALL_GIT=true

# Development tool options (only applies if respective runtime is installed)
# PHP development tools (Composer, Xdebug) - only if INSTALL_PHP=true
INSTALL_PHP_DEV_TOOLS=false
# Node.js development tools (Yarn, TypeScript) - only if INSTALL_NODEJS=true
INSTALL_NODEJS_DEV_TOOLS=false

# =============================================================================
# ADVANCED SYSTEM FEATURES (Optional)
# =============================================================================

# Resource Guardian - Automatic resource protection system
# Prevents server crashes by automatically managing runaway processes
#
# What it does:
#   ‚Ä¢ Monitors CPU, memory, and load every 5 minutes
#   ‚Ä¢ Sends EMAIL ALERTS before taking action (2-minute warning)
#   ‚Ä¢ Terminates processes that exceed thresholds for sustained periods
#   ‚Ä¢ Protects critical services (SSH, nginx, docker, systemd, fail2ban)
#
# Thresholds (production-safe):
#   CPU: 85% for 10+ minutes ‚Üí Warning ‚Üí Terminate after 2 min grace period
#   Memory: 90% warning, 95% critical ‚Üí Emergency cleanup
#   Load: 2x CPU count ‚Üí Alert only (no automatic action)
#
# Use case: Prevents memory leaks, CPU-intensive bugs, or DoS attacks from
#           crashing your server. Ideal for production servers that must
#           maintain uptime even if applications misbehave.
#
# Logs: /var/log/resource-guardian.log
# Status: sudo systemctl status resource-guardian.timer
INSTALL_RESOURCE_GUARDIAN=false

# Advanced Monitoring Commands - Convenient CLI tools for server management
# Installs 3 commands that all users can run (except logmon needs sudo)
#
# 1. serverstatus
#    Comprehensive server health dashboard showing:
#    ‚Ä¢ System info (hostname, uptime, load, users)
#    ‚Ä¢ Resource usage (CPU, RAM, disk, swap)
#    ‚Ä¢ Service status (SSH, nginx, docker, fail2ban, etc.)
#    ‚Ä¢ Recent security events and alerts
#    Usage: Just run "serverstatus" from any user account
#
# 2. logmon [type]
#    Real-time log monitoring with intelligent filtering
#    Types: auth, security, system, nginx, all
#    Shows: Failed logins, security events, errors, access attempts
#    Usage: sudo logmon auth  (watch SSH login attempts)
#           sudo logmon nginx (watch web server logs)
#           sudo logmon security (watch all security events)
#
# 3. servermail
#    Read local system mail without email client
#    Shows: Security alerts, cron job output, system notifications
#    Usage: Just run "servermail" to see your system notifications
#
# Use case: Quick diagnostics and monitoring without needing to remember
#           complex log paths or grep commands. Great for quick health checks.
INSTALL_ADVANCED_MONITORING=false

# Application Performance & Logging Configuration
# PHP settings (only applies if INSTALL_PHP=true)
ENABLE_PHP_SLOW_LOG=true
ENABLE_PHP_OPCACHE=true
ENABLE_PHP_REQUEST_TIMEOUT=true
PHP_REQUEST_TIMEOUT=600

# Database settings (only applies if INSTALL_MARIADB=true or INSTALL_POSTGRESQL=true)
ENABLE_MYSQL_SLOW_LOG=true
MYSQL_SLOW_LOG_TIME=2

# Redis settings (only applies if INSTALL_REDIS=true)
ENABLE_REDIS_SLOW_LOG=true
REDIS_SLOW_LOG_TIME=10000

# Optional Security Components (resource-aware defaults)
# ClamAV antivirus (HIGH resource usage)
INSTALL_CLAMAV=false
# Linux Malware Detect (MEDIUM resource usage)
INSTALL_MALDET=false
# Rootkit detection tools (LOW resource usage)
INSTALL_RKHUNTER=true
# Suricata IDS (MEDIUM resource usage)
INSTALL_SURICATA=true

# =============================================================================
# SECURITY FEATURES CONFIGURATION
# =============================================================================

# Audit Framework
AUDIT_ENABLED=true
AUDIT_LOG_RETENTION=90
AUDIT_BUFFER_SIZE=8192
AUDIT_FAILURE_MODE=1
AUDIT_RULES_IMMUTABLE=false  # Set to true to make rules immutable (requires reboot to change)

# =============================================================================
# SYSTEM MONITORING CONFIGURATION
# =============================================================================

# Server monitoring settings
LOGWATCH_EMAIL=admin@example.com
LOGWATCH_DETAIL=Med  # Low, Med, High
LOGWATCH_RANGE=yesterday

# Netdata monitoring settings
NETDATA_ENABLED=false
# NETDATA_CLAIM_TOKEN=your_claim_token  # For Netdata Cloud integration

# Access control (set to empty to allow public access, NOT recommended)
NETDATA_ALLOW_LOCAL_ACCESS=127.0.0.1

# =============================================================================
# UNBOUND DNS CACHE SETTINGS (dual-stack with DNSSEC)
# =============================================================================

UNBOUND_ENABLED=true
UNBOUND_VERBOSITY=1
UNBOUND_CACHE_MIN_TTL=3600
UNBOUND_CACHE_MAX_TTL=86400
UNBOUND_MSG_CACHE_SIZE=128m
UNBOUND_RRSET_CACHE_SIZE=256m
UNBOUND_NEG_CACHE_SIZE=64m
UNBOUND_LOG_QUERIES=no
UNBOUND_LOG_REPLIES=no
UNBOUND_LOG_SERVFAIL=yes
UNBOUND_LOGFILE=/var/log/unbound.log
# Optional fallback DNS servers (enabled by default for reliability)
UNBOUND_DNS_PRIMARY=8.8.8.8
UNBOUND_DNS_SECONDARY=1.1.1.1

# =============================================================================
# WEB SERVER & SECURITY CONFIGURATION
# =============================================================================

# SSL/TLS settings (for applications requiring HTTPS)
SSL_EMAIL=admin@example.com
SSL_STAGING=false  # Set to true for Let's Encrypt staging environment

# AppArmor profile name (application-agnostic)
APPARMOR_PROFILE=polyserver-default

# Rate limiting (requests per second) - base security setting
RATE_LIMIT=10

# ModSecurity WAF
MODSECURITY_ENABLED=true
MODSECURITY_AUDIT_LOG=/var/log/nginx/modsec_audit.log

# Suricata IDS
SURICATA_ENABLED=true
SURICATA_INTERFACE=auto  # Will auto-detect primary interface

# Suricata service monitoring configuration
# Set to true to monitor services running on THIS server, false to monitor external traffic only
SURICATA_MONITOR_HTTP=true       # Web services (nginx, apache, etc.)
SURICATA_MONITOR_DATABASE=false  # Database services (MySQL, PostgreSQL, etc.)
SURICATA_MONITOR_DNS=false       # Authoritative DNS server (BIND9, etc.) - not Unbound resolver
SURICATA_MONITOR_MAIL=false      # Mail server (Postfix, Exim, etc.) - not SMTP relay
SURICATA_MONITOR_FTP=false       # FTP services

# Container security scanning
TRIVY_ENABLED=true
TRIVY_SEVERITY=HIGH,CRITICAL

# =============================================================================
# MONITORING & ALERTING
# =============================================================================
# These notification channels receive real-time alerts from:
#   - Netdata: System health, performance, resource usage (CPU, RAM, disk, network)
#   - Security: Rootkit scans, file integrity changes, suspicious activity
#   - Docker: Container CPU/memory usage, container health status
#   - Services: nginx errors, failed services, system failures
#
# Alert Types You'll Receive:
#   üî¥ CRITICAL: Service down, out of memory, rootkit detected
#   ‚ö†Ô∏è  WARNING: High CPU usage (>80%), disk space low, container issues
#   ‚ÑπÔ∏è  INFO: Service restarts, configuration changes
# =============================================================================

# Discord notifications (enabled automatically if webhook URL is provided)
# Create webhook: Discord Server ‚Üí Settings ‚Üí Integrations ‚Üí Webhooks
# DISCORD_WEBHOOK_URL=https://discord.com/api/webhooks/your_webhook

# Slack notifications
# Create webhook: https://api.slack.com/messaging/webhooks
SLACK_ENABLED=NO
# SLACK_WEBHOOK_URL=https://hooks.slack.com/services/your_webhook

# Telegram notifications
# Create bot: Talk to @BotFather on Telegram to get bot token
# Get chat ID: Send message to bot, then visit: https://api.telegram.org/bot<TOKEN>/getUpdates
TELEGRAM_ENABLED=NO
# TELEGRAM_BOT_TOKEN=your_bot_token
# TELEGRAM_CHAT_ID=your_chat_id

# Email notifications (via Netdata's built-in email sender)
# Note: For system-wide email delivery (cron jobs, logwatch, security reports),
# configure the SMTP_* settings below instead. These settings are ONLY for Netdata.
EMAIL_NOTIFICATION=NO
# EMAIL_RECIPIENT=alerts@example.com
# EMAIL_SENDER=netdata@example.com
# EMAIL_SERVER=smtp.example.com
# EMAIL_PORT=465
# EMAIL_USERNAME=netdata@example.com
# EMAIL_PASSWORD=your_password
# EMAIL_SSL=yes

# =============================================================================
# SMTP EMAIL CONFIGURATION (System-Wide)
# =============================================================================

# SMTP Configuration for system-wide email delivery (logwatch, fail2ban, security alerts)
# This is separate from Netdata EMAIL_* settings above
# Set SMTP_ENABLED=true to configure external SMTP relay for all system notifications
# If disabled (false), all system emails will be delivered locally to /var/mail/root
SMTP_ENABLED=false

# SMTP server settings (required if SMTP_ENABLED=true)
# SMTP_SERVER=smtp.gmail.com
# SMTP_PORT=587
# SMTP_USERNAME=your-email@gmail.com
# SMTP_PASSWORD=your-app-password
# SMTP_FROM_EMAIL=your-email@gmail.com
# SMTP_USE_TLS=true

# Example configurations for common providers:
# Gmail: smtp.gmail.com:587 (use App Password, not regular password)
# Amazon SES: email-smtp.region.amazonaws.com:587
# Outlook: smtp-mail.outlook.com:587

# =============================================================================
# DSGVO/GDPR COMPLIANCE
# =============================================================================

# GDPR compliance settings (customize for your organization)
GDPR_ENABLED=true
GDPR_DPO_EMAIL=dpo@example.com
GDPR_DPO_NAME="Data Protection Officer"
GDPR_ORGANIZATION="Your Organization"
GDPR_CONTACT_ADDRESS="Your Organization Address"
GDPR_RETENTION_PERIOD=2555  # Default retention in days (7 years)
GDPR_BREACH_NOTIFICATION_EMAIL=security@example.com

# Data subject request handling
DSR_EMAIL=privacy@example.com
DSR_RESPONSE_TIME=30  # Days to respond to data subject requests

# =============================================================================
# PERFORMANCE OPTIMIZATION CONFIGURATION
# =============================================================================

# System resource optimization settings
# These values are automatically detected during setup and can be overridden

# Nginx performance settings (auto-calculated based on CPU cores)
NGINX_WORKERS=auto
NGINX_WORKER_CONNECTIONS=1024

# Nginx buffer settings
NGINX_CLIENT_BODY_BUFFER_SIZE=16k
NGINX_CLIENT_HEADER_BUFFER_SIZE=1k

# PHP-FPM performance settings (auto-calculated based on system RAM)
PHP_MAX_CHILDREN=50
PHP_START_SERVERS=10
PHP_MIN_SPARE_SERVERS=5
PHP_MAX_SPARE_SERVERS=20
PHP_MAX_REQUESTS=1000
PHP_MEMORY_LIMIT=256
PHP_MAX_EXECUTION_TIME=300
PHP_MAX_INPUT_TIME=300
PHP_POST_MAX_SIZE=50
PHP_UPLOAD_MAX_FILESIZE=25

# PHP Advanced Settings (optional)
PHP_SLOW_LOG_ENABLED=false
PHP_SLOW_LOG_TIMEOUT=10
PHP_REQUEST_TERMINATE_TIMEOUT=""
PHP_OPCACHE_ENABLED=true
PHP_OPCACHE_MEMORY=128
PHP_OPCACHE_STRINGS_BUFFER=16
PHP_OPCACHE_MAX_FILES=10000
PHP_APCU_ENABLED=false
PHP_APCU_MEMORY=64
PHP_REALPATH_CACHE_SIZE=4096
PHP_XDEBUG_ENABLED=false

# MariaDB/MySQL performance settings (auto-calculated based on system RAM)
MYSQL_MAX_CONNECTIONS=151
MYSQL_MAX_USER_CONNECTIONS=150
MYSQL_THREAD_CACHE_SIZE=8
MYSQL_INNODB_BUFFER_POOL_SIZE=128
MYSQL_INNODB_BUFFER_POOL_INSTANCES=1
MYSQL_INNODB_LOG_BUFFER_SIZE=16
MYSQL_INNODB_LOG_FILE_SIZE=48
MYSQL_INNODB_IO_CAPACITY=200
MYSQL_INNODB_IO_CAPACITY_MAX=400
MYSQL_INNODB_READ_IO_THREADS=4
MYSQL_INNODB_WRITE_IO_THREADS=4
MYSQL_KEY_BUFFER_SIZE=128
MYSQL_SORT_BUFFER_SIZE=2
MYSQL_JOIN_BUFFER_SIZE=2
MYSQL_TMP_TABLE_SIZE=64
MYSQL_MAX_HEAP_TABLE_SIZE=64
MYSQL_TABLE_OPEN_CACHE=2000
MYSQL_TABLE_DEFINITION_CACHE=1400

# MySQL Advanced Settings (optional)
MYSQL_GENERAL_LOG_ENABLED=false
MYSQL_SLOW_LOG_ENABLED=true
MYSQL_SLOW_QUERY_TIME=2
MYSQL_LOG_QUERIES_NOT_USING_INDEXES=false
MYSQL_BINLOG_ENABLED=false
MYSQL_BINLOG_EXPIRE_DAYS=7
MYSQL_REPLICATION_ENABLED=false
MYSQL_SERVER_ID=1
MYSQL_PERFORMANCE_SCHEMA_ENABLED=false

# PostgreSQL performance settings (auto-calculated based on system RAM)
# Connection settings
PGSQL_MAX_CONNECTIONS=100
PGSQL_SUPERUSER_RESERVED_CONNECTIONS=3

# Memory settings (in MB)
PGSQL_SHARED_BUFFERS=128          # Typically 25% of RAM
PGSQL_WORK_MEM=4                  # Per-query work memory
PGSQL_MAINTENANCE_WORK_MEM=64     # For VACUUM, CREATE INDEX, etc.
PGSQL_AUTOVACUUM_WORK_MEM=64      # For autovacuum workers
PGSQL_EFFECTIVE_CACHE_SIZE=512    # OS + PostgreSQL cache (50-75% of RAM)
PGSQL_TEMP_BUFFERS=8              # Temporary buffers per session

# WAL settings (in MB)
PGSQL_WAL_BUFFERS=16
PGSQL_MIN_WAL_SIZE=80
PGSQL_MAX_WAL_SIZE=1024
PGSQL_WAL_LEVEL=replica           # minimal, replica, or logical

# Query planner settings
PGSQL_RANDOM_PAGE_COST=1.1        # For SSDs: 1.1, HDDs: 4.0
PGSQL_EFFECTIVE_IO_CONCURRENCY=200 # For SSDs: 200, HDDs: 2

# Parallel query settings
PGSQL_MAX_PARALLEL_WORKERS_PER_GATHER=2
PGSQL_MAX_PARALLEL_WORKERS=4
PGSQL_MAX_PARALLEL_MAINTENANCE_WORKERS=2

# Logging settings
PGSQL_LOG_MIN_DURATION=1000       # Log queries slower than 1000ms (-1 to disable)
PGSQL_LOG_CONNECTIONS=off         # Log all connections
PGSQL_LOG_DISCONNECTIONS=off      # Log all disconnections
PGSQL_LOG_STATEMENT=none          # none, ddl, mod, all

# Autovacuum settings
PGSQL_AUTOVACUUM_MAX_WORKERS=3

# Statistics settings
PGSQL_TRACK_IO_TIMING=on          # Useful for performance analysis
PGSQL_TRACK_FUNCTIONS=none        # none, pl, all
PGSQL_DEFAULT_STATISTICS_TARGET=100

# Security settings
PGSQL_SSL_ENABLED=off             # Enable if SSL certificates configured

# Performance features
PGSQL_JIT_ENABLED=off             # JIT compilation (requires LLVM, PostgreSQL 11+)

# Replication settings (optional)
PGSQL_REPLICATION_ENABLED=false
PGSQL_MAX_WAL_SENDERS=3
PGSQL_WAL_KEEP_SIZE=512
PGSQL_SHARED_PRELOAD_LIBRARIES=   # e.g., pg_stat_statements

# Redis performance settings (auto-calculated based on system RAM)
REDIS_MAX_MEMORY=64
REDIS_MAX_CLIENTS=10000
REDIS_RDB_ENABLED=true
REDIS_AOF_ENABLED=false
REDIS_SLOW_LOG_ENABLED=true
REDIS_SLOW_LOG_TIME=10000
REDIS_SLOW_LOG_MAX_LEN=128
REDIS_LATENCY_MONITOR_ENABLED=false
REDIS_LATENCY_THRESHOLD=100
REDIS_ACTIVE_DEFRAG_ENABLED=false
REDIS_CLUSTER_ENABLED=false
# REDIS_PASSWORD=""
# REDIS_SHUTDOWN_SECRET=""

# Node.js performance settings (auto-calculated based on system specs)
NODE_MAX_OLD_SPACE_SIZE=512
NODE_UV_THREADPOOL_SIZE=4
NODE_MAX_HTTP_HEADER_SIZE=8192

# =============================================================================
# DEVELOPMENT/TESTING CONFIGURATION
# =============================================================================

# These settings are used for local development and testing environments
# Production deployments should override these values

# Development environment settings
DEV_MODE=false
DEV_NGINX_PORT=8080
DEV_NETDATA_PORT=19999

# Testing configuration
TEST_MODE=false
